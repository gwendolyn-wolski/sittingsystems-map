<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sitting Systems â€” Map</title>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <!-- Clustering -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100vh; width: 100vw; background: #f4f4f4; }

    .leaflet-container a:focus { outline: none; }

    .leaflet-control-zoom a {
      border-radius: 10px !important;
      width: 34px !important;
      height: 34px !important;
      line-height: 34px !important;
      box-shadow: 0 6px 20px rgba(0,0,0,.12) !important;
      border: 1px solid rgba(0,0,0,.08) !important;
    }
    .leaflet-control-zoom {
      border: 0 !important;
      box-shadow: none !important;
    }

    .leaflet-popup-content-wrapper {
      border-radius: 18px !important;
      box-shadow: 0 18px 40px rgba(0,0,0,.18) !important;
      border: 1px solid rgba(0,0,0,.08) !important;
    }
    .leaflet-popup-content {
      margin: 14px !important;
      width: 280px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
    .leaflet-control-attribution {
      font-size: 10px !important;
      opacity: .45;
    }
    .leaflet-popup-tip { box-shadow: none !important; }

    .ss-thumb{
      display: block;
      width: 100% !important;
      max-width: 280px !important;
      height: 160px !important;
      object-fit: cover !important;
      border-radius: 14px;
      margin: 0 0 10px 0;
    }
    .ss-title {
      font-size: 16px;
      line-height: 1.25;
      font-weight: 650;
      margin: 0 0 6px 0;
      letter-spacing: -0.01em;
    }
    .ss-meta {
      margin-top: 6px;
      font-size: 12px;
      letter-spacing: .02em;
      text-transform: uppercase;
      opacity: .6;
    }
    .ss-link {
      display: inline-block;
      margin-top: 6px;
      font-size: 14px;
      text-decoration: none;
      border-bottom: 1px solid rgba(0,0,0,.35);
      padding-bottom: 1px;
      color: #111;
    }
    .ss-link:hover { border-bottom-color: rgba(0,0,0,.75); }

    /* --- Minimal cluster styling (overrides default) --- */
    .marker-cluster,
    .marker-cluster div {
    background: transparent !important;
    border: none !important;
    box-shadow: none !important;
    }

    .marker-cluster div {
    width: 30px !important;
    height: 30px !important;
    border-radius: 999px !important;
    background: rgba(17,17,17,.88) !important;
    border: 1px solid rgba(255,255,255,.35) !important;
    box-shadow: 0 10px 18px rgba(0,0,0,.14) !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    }

    .marker-cluster span {
    color: #fff !important;
    font-weight: 650 !important;
    font-size: 11px !important;
    line-height: 1 !important;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- Clustering -->
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <script>
    const IS_DESKTOP_POINTER = window.matchMedia("(pointer: fine)").matches;

    const map = L.map('map', {
        zoomControl: false,
        scrollWheelZoom: true,
        tap: false
    });
const worldBounds = L.latLngBounds(
  L.latLng(-85, -180),
  L.latLng( 85,  180)
);
map.setMaxBounds(worldBounds);
map.options.maxBoundsViscosity = 1.0;

    L.control.zoom({ position: 'bottomright' }).addTo(map);
    map.on('click', () => map.scrollWheelZoom.enable());
    map.on('mouseout', () => map.scrollWheelZoom.enable());

    L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", {
      attribution: "&copy; OpenStreetMap &copy; CARTO",
      subdomains: "abcd",
      maxZoom: 19,
      noWrap: true
    }).addTo(map);

    function extractThumbUrl(thumbnailField) {
      if (!thumbnailField) return '';
      const match = String(thumbnailField).match(/\((https?:\/\/[^\)]+)\)/);
      return match ? match[1] : '';
    }
    function toNum(x) {
      const n = Number(x);
      return Number.isFinite(n) ? n : null;
    }

    // --- Cluster group ---
    const clusters = L.markerClusterGroup({
      // Keep it minimal and calm
      spiderfyOnMaxZoom: true,
      showCoverageOnHover: false,
      zoomToBoundsOnClick: true,
      maxClusterRadius: 45,
      animate: true
    });

    fetch('./data.json')
      .then(r => r.json())
      .then(records => {
        const bounds = [];

        records.forEach(rec => {
          const lat = toNum(rec["Latitude"]);
          const lng = toNum(rec["Longitude"]);
          if (lat === null || lng === null) return;

          const url = rec["Readymag_URL"] || '';
          const label = rec["Map_Label"] || rec["Display_ID"] || 'View';
          const context = rec["Context (Primary)"] || '';
          const thumbUrl = extractThumbUrl(rec["Thumbnail"]);

          const popupHtml = `
            <div class="ss-popup">
              ${thumbUrl ? `<img class="ss-thumb" src="${thumbUrl}" alt="">` : ``}
              <div class="ss-title">${label}</div>
              ${url ? `<a class="ss-link" href="${url}" target="_blank" rel="noopener">Open object page</a>` : ``}
              ${context ? `<div class="ss-meta">${context}</div>` : ``}
            </div>
          `;

        const marker = L.circleMarker([lat, lng], {
            radius: 5,
            color: "rgba(0,0,0,.18)",
            weight: 4,
            fillColor: "#111",
            fillOpacity: 0.95
        });

          marker.bindPopup(popupHtml, {
            closeButton: true,
            autoClose: true,
            closeOnClick: true
          });

          marker.on('mouseover', () => marker.setStyle({ radius: 7 }));
          marker.on('mouseout',  () => marker.setStyle({ radius: 5 }));

          if (IS_DESKTOP_POINTER) {
            marker.on('mouseover', () => marker.openPopup());
            marker.on('mouseout', (e) => {
              const related = e.originalEvent && e.originalEvent.relatedTarget;
              if (related && related.closest && related.closest('.leaflet-popup')) return;
              marker.closePopup();
            });
            marker.on('popupopen', () => {
              const el = marker.getPopup().getElement();
              if (!el) return;
              el.addEventListener('mouseenter', () => marker.openPopup());
              el.addEventListener('mouseleave', () => marker.closePopup());
            });
          }

          clusters.addLayer(marker);
          bounds.push([lat, lng]);
        });

        map.addLayer(clusters);

        if (bounds.length) {
          map.fitBounds(bounds, { padding: [40, 40], maxZoom: 5 });
        } else {
          map.setView([0, 0], 2);
        }
      })
      .catch(err => {
        console.error('Failed to load data.json', err);
        map.setView([0, 0], 2);
      });
  </script>
</body>
</html>